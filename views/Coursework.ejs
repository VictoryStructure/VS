<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <title>Coursework</title>
      <link rel="stylesheet" href="css/HomeVS.css">
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
      <link rel="icon" href="asset/ICON.png">
   </head>
   <body>
      <div class="wrapper">
         <div class="sidebar">
            <h2>Victory Structure</h2>
            <ul>
               <li><a href="/">Home</a></li>
               <li><a href="/module">Module</a></li>
               <li><a href="/allcoursework"></i>All Coursework</a></li>
               <li><a href="/about"></i>About</a></li>
            </ul>
            <div class="options">
               <ul>
                  <li><a href="/settings">Account and Settings</a></li>
                  <li>
                     <form action="/logout?_method=DELETE" method="POST">
                        <button type="submit" class="linked_button">Log Out</button>
                     </form>
                  </li>
               </ul>
            </div>
         </div>
         <div class="main_content">
            <div class="header">All Coursework</div>
            <div class ="button-group">
               <form action = "/createcoursework" method = "GET">
                  <button class = "button1" type = "submit"> Create Coursework</button>
               </form>
            </div>
            <div class="info">
			   <label for = "selectContainer">Filter by Module</label>
               <div id="selectContainer">
                  <input id="search-input" class="form-control" type="text">
               </div>
               <div class = "table">
                  <table id = "coursework_table" class = "table">
                        <tr>
                           <th data-column="courseworkname" data-order="desc">Coursework Name &#9650</th>
                           <th data-column="description" data-order="desc">Description &#9650</th>
                           <th data-column="deadline" data-order="desc">Deadline &#9650</th>
                           <th data-column="markvalue" data-order="desc">Mark Value &#9650</th>
                           <th data-column="notes" data-order="desc">Notes &#9650</th>
                           <th data-column="percentage" data-order="desc">Progress &#9650</th>
                           <th data-column="modulename " data-order="desc">Module &#9650</th>
                        </tr>
                        <tbody id = "tbody">
                        </tbody>
                  </table>
               </div>
               <script>
                  var userid = <%= passedid %>;
                  var jsondata = <%-JSON.stringify(coursework_json)%>;

                  $('th').on('click', function(){
                  		var column = $(this).data('column')
                  		var order = $(this).data('order')
                        var text = $(this).html();
                        text = text.substring(0, text.length - 1)
                  		console.log('Column was clicked', column, order)
                  
                  	if (order == 'desc'){
                  		$(this).data("order", "asc")
                  		console.log(jsondata[userid])
                  		jsondata[userid] = jsondata[userid].sort((a,b) => a[column] > b[column] ? 1 : -1)
                        text += '&#9660'
                  	}else{ 
                  		$(this).data("order", "desc")
                  		console.log(jsondata[userid])
                  		jsondata[userid] = jsondata[userid].sort((a,b) => a[column] < b[column] ? 1 : -1)
                        text += '&#9650'
                  	}
                     $(this).html(text)
                  	buildtable(jsondata[userid]);
                  })

                  $('#search-input').on('keyup', function(){
                     var value = $(this).val();
                     var data = searchTable(value, jsondata[userid])
                     buildtable(data)
                  })
                  
                  buildtable(jsondata[userid]);
                  
                  function searchTable(value, data){
                     var filteredData = [];

                     for(var i = 0; i < data.length; i++){
                        value = value.toLowerCase();
                        var name = String(data[i].name).toLowerCase()
                        console.log("Value:", value);
                        console.log("Name:", name);
                     
                        if(name.includes(value)){
                           filteredData.push(data[i])
                        }
                     }

                     return filteredData;  
                  }

                  function buildtable(data){
                     var table = document.getElementById("tbody")
                     table.innerHTML = '';
                     for(var i = 0; i < data.length; i++){
                        var row = `<tr>
                                    <td>${data[i].courseworkname}</td>
                                    <td>${data[i].description}</td>
                                    <td>${data[i].deadline}</td>
                                    <td>${data[i].markvalue}</td>
                                    <td>${data[i].notes}</td>
                                    <td>${data[i].percentage}</td>
                                    <td>${data[i].modulename}</td>
                                  </tr>`
                        table.innerHTML += row
                     }
                  }
               </script>
               
               <form action="#" method="POST">
                  <label for = "selectContainer">Select a Coursework</label>
                  <div id="selectContainer2">
                     <script>
                        $(document).ready(function(){
                        	let userid = <%= passedid %>;
                        	var data = <%-JSON.stringify(coursework_json)%>;
                        	var ddl = document.createElement("SELECT");
                        	$.each(data[userid],function(key, value){
                        		var option = document.createElement("OPTION");
                        		option.innerHTML = value.courseworkname;
                        		ddl.options.add(option);
                        	});
                        	document.getElementById('selectContainer2').appendChild(ddl);  
                        	ddl.setAttribute("name", "selectpage");
                        });
                     </script>
                  </div>
                  <button type="submit" class="linked_button" id="form_submit">Submit</button>       
               </form>
            </div>
         </div>
      </div>
      </div>
   </body>
</html>